version: 1
applications:
  - appRoot: /
    frontend:
      buildPath: / # Run install and build from the monorepo project root
      phases:
        preBuild:
          commands:
            - npm ci --cache .npm --prefer-offline
        build:
          commands:
            - npm run build
            - mv build .amplify-hosting
            - mv .amplify-hosting/client .amplify-hosting/static
            - mkdir -p .amplify-hosting/compute
            - mv .amplify-hosting/server .amplify-hosting/compute/default
            - npm ci --omit dev
            - cp package.json .amplify-hosting/compute/default
            - cp -r node_modules .amplify-hosting/compute/default
            - cp server.js .amplify-hosting/compute/default
      artifacts:
        baseDirectory: .amplify-hosting
        files:
          - "**/*"
      cache:
        paths:
          - .npm/**/*
